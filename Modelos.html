<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Carlos Mario Castaño Suaza">
<meta name="author" content="Juan Pablo Lara Chaves">
<meta name="author" content="María Paula Camargo Rincón">

<title>Algoritmo de Fisher Scoring</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Modelos_files/libs/clipboard/clipboard.min.js"></script>
<script src="Modelos_files/libs/quarto-html/quarto.js"></script>
<script src="Modelos_files/libs/quarto-html/popper.min.js"></script>
<script src="Modelos_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Modelos_files/libs/quarto-html/anchor.min.js"></script>
<link href="Modelos_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Modelos_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Modelos_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Modelos_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Modelos_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">

<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Algoritmo de Fisher Scoring</h1>
</div>



<div class="quarto-title-meta column-page">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Carlos Mario Castaño Suaza </p>
             <p>Juan Pablo Lara Chaves </p>
             <p>María Paula Camargo Rincón </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="regresión-poisson" class="level2">
<h2 class="anchored" data-anchor-id="regresión-poisson">Regresión Poisson</h2>
<ul>
<li>Sean <span class="math inline">\(Y_1, Y_2, \cdots, Y_n\)</span> variables aleatorias independientes con distribución <em>Poisson</em>, tales que</li>
</ul>
<p><span class="math display">\[Y_i \sim Poisson(\mu_i) \quad i=1,2,\cdots,n.\]</span> Sabemos que en la distribución <em>Poisson</em>, el parámetro canónico está dado por <span class="math inline">\(\theta_i = \ln(\mu_i)\)</span>.</p>
<p>En el contexto de un modelo de regresión, el predictor lineal <span class="math inline">\(\eta_i\)</span> está dado por</p>
<p><span class="math display">\[\eta_i = \beta_0 + \beta_1X_1 + \beta_2X_2 + \cdots + \beta_pX_p,\]</span> y la relación entre el predictor <span class="math inline">\(\eta_i\)</span> y la media <span class="math inline">\(\mu_i\)</span>, en el caso de la regresión <em>Poisson</em>, está dada por</p>
<p><span class="math display">\[\eta_i = \ln(\mu_i) \Rightarrow \mu_i = \exp(\eta_i).\]</span></p>
<p>La función de log-verosimilitud es como sigue</p>
<p><span class="math display">\[
\begin{align*}
\mathcal{l}(\beta) &amp;= \sum_{i=1}^n \left[y_i\ln(\mu_i) - \mu_i - \ln(y_i!)\right]\\
&amp;= \sum_{i=1}^n \left[y_i x_i^t \beta - \exp(x_i^t \beta) - \ln(y_i!)\right]
\end{align*}
\]</span></p>
<p>La <strong>función score</strong> (vector de primeras derivadas) está dado por</p>
<p><span class="math display">\[\frac{\partial \mathcal{l}(\beta)}{\partial \beta} = \sum_{i=1}^n (y_i - \mu_i)x_i.\]</span> La <strong>Matriz de Información de Fisher</strong> es como sigue</p>
<p><span class="math display">\[\mathcal{J}(\beta) = Inf = X^tWX\]</span> donde</p>
<p><span class="math display">\[W = diag\left(\frac{\left(\frac{\partial \mu_i}{\partial \eta_i}\right)^2}{Var(y_i)}\right)\]</span> <span class="math display">\[\frac{\partial \mu_i}{\partial \eta_i} = \mu_i, \quad \quad \quad \frac{\partial \eta_i}{\partial \mu_i} = \frac{1}{\mu_i}\]</span> Como en la distribución <em>Poisson</em>, <span class="math inline">\(Var(Y_i) = \mu_i\)</span>, se tiene que</p>
<p><span class="math display">\[w_{ii} = \frac{\mu_i^2}{\mu_i} =\mu_i\]</span> y la variable ajustada <span class="math inline">\(\widetilde{y}\)</span> está dada por <span class="math display">\[\widetilde{y} = \eta_i + (y_i - \mu_i)\frac{\partial \eta_i}{\partial \mu_i} = \eta_i + (y_i - \mu_i)\frac{1}{\mu_i}\]</span></p>
<p>De esta forma, el <strong>Algoritmo de Fisher-Scoring</strong> queda determinado por los siguientes pasos:</p>
<ol type="1">
<li>Iniciar el algoritmo con un valor inicial para <span class="math inline">\(\beta\)</span>. Se usará una estimación inicial de <span class="math inline">\(\beta_0^{(0)}\)</span> usando la media global de <span class="math inline">\(y\)</span></li>
</ol>
<p><span class="math display">\[
\beta_0^{(0)} = \log\left(\frac{1}{n}\sum_{i=1}^n y_i\right), \quad
\beta_1^{(0)} = 0, \quad \cdots, \quad
\beta_p^{(0)} = 0.
\]</span></p>
<ol start="2" type="1">
<li>Obtener <span class="math inline">\(\beta^{(k+1)}\)</span> a partir de <span class="math inline">\(\beta^{(k)}\)</span> usando la siguiente expresión</li>
</ol>
<p><span class="math display">\[\beta^{(k+1)} = \left(X^tW^{(k)}X\right)^{-1}X^tW^{(k)}\widetilde{y}^{(k)}.\]</span></p>
<ol start="3" type="1">
<li>Repetir <strong>(2)</strong> hasta satisfacer un criterio de convergencia. El criterio de convergencia que se usará en este caso es el siguiente</li>
</ol>
<p><span class="math display">\[\max_j \left| \beta_j^{(k+1)} - \beta_j^{(k)} \right| &lt; \epsilon, \quad \quad \epsilon=0.0000001\]</span></p>
<section id="residuales" class="level3">
<h3 class="anchored" data-anchor-id="residuales">Residuales</h3>
<p>El estudio de los residuales es importante ya que ayuda a evaluar la calidad del modelo y detectar posibles desviaciones de los supuestos del mismo. En este caso se ha trabajado con los residuales crudos, los residuales de Pearson, los residuales de devianza y los residuales de Anscombe.</p>
<ul>
<li><p><strong>Residuales crudos (o de respuesta):</strong> estos residuales son normalmente usados en modelos de regresión lineal; en modelos lineales generalizados realmente no son tan eficientes. Sin embargo, se decidió usar este tipo de residuales debido a que se quiere comparar con los otros tipos. Estos residuales representan la diferencia entre el valor observado y el valor ajustado de la media:</p>
<p><span class="math display">\[r = y-\hat{\mu}\]</span></p></li>
<li><p><strong>Residuales de Pearson:</strong> estandariza el residual crudo dividiéndolo por la desviación estándar estimada para la distribución en cuestión. La formula general y en el caso de la Poisson son:</p>
<p><span class="math display">\[r_{P}=\frac{y-\hat{\mu}}{\sqrt{Var(\hat{\mu})}}\Longrightarrow\frac{y-\hat{\mu}}{\sqrt{\hat{\mu}}}\]</span></p></li>
<li><p><strong>Residuales de devianza:</strong> los residuos de devianza, como conjunto, suelen ser más cercanos a la normalidad con distribuciones GLM no normales que los residuos de Pearson.</p>
<p><span class="math display">\[r_{D}=sign(y-\mu)\sqrt{d_{i}},\hspace{3cm}donde:d_{i}=\sqrt{2 \left[ \ell(y_i; y_i) - \ell(\hat{\mu}_i; y_i) \right]}\]</span> Para el caso de la Poisson:</p></li>
</ul>
<p><span class="math display">\[r_{D}=sign(y-\mu)\sqrt{2\left(y\cdot log(\frac{y}{\mu})-(y-\mu)\right)}\]</span></p>
<ul>
<li><p><strong>Residuales de Anscombe:</strong> como los residuales de Pearson suelen ser sesgados para distribuciones no normales y esto ocasionaba que no podía tener propiedades similares a la de los residuos de la teoría normal, Anscombe propuso definir un residuo utlizando una función <span class="math inline">\(A(y)\)</span> en lugar de y, la formula general y en el caso de la Poisson son:</p>
<p><span class="math display">\[A(\cdot)=\int \frac{d\mu}{V^{1/3}(\mu)}\Longrightarrow\int\frac{d\mu}{\mu^{1/3}}=\frac{3}{2}\mu^{2/3}\]</span></p>
<p>Para la distribución Poisson:</p>
<p><span class="math display">\[r_{A}=\frac{\frac{3}{2}(y^{2/3}-\mu^{2/3})}{\mu^{1/6}}\]</span></p></li>
</ul>
</section>
<section id="datos-a-usar" class="level3">
<h3 class="anchored" data-anchor-id="datos-a-usar">Datos a usar</h3>
<p>A continuación se presenta el algoritmo para encontrar una aproximación de <span class="math inline">\(\beta\)</span> usando datos reales.</p>
<p>Datos de jugadores de baloncesto de la temporada 2022-2023, los cuales incluyen la edad del jugador (AGE), tiempo en minutos jugado en la temporada (MIN), juegos participados (GP), tiros de campo hechos (FGM), tiros de campo intentados (FGA), tiros de campo hechos de 3 puntos (FG3M), tiros de campo intentados de 3 puntos (FGA) y puntos realizados en la temporada (PTS).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># seleccionamos las variables de interés</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>players <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"players_202223.xlsx"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(AGE, MIN, GP, FGM, FGA, FG3M, FG3A, FTM, FTA, PTS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>players <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">"cor"</span>, <span class="at">size =</span> <span class="dv">3</span>)),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">diag =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">"barDiag"</span>, <span class="at">colour =</span> <span class="st">"burlywood"</span>)),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">"points"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">shape =</span> <span class="dv">20</span>, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">fill =</span> <span class="st">"lightblue"</span>)),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">axisLabels =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Modelos_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>En la matriz de dispersión realizada se usó el coeficiente de correlación de Pearson, el cuál nos muestra que la mayoría de las variables tienen una alta correlación lineal con la variable respuesta, puntos realizados en la temporada (PTS).</p>
<p>Se puede evidenciar que entre las variables tambien se presentan algunas correlaciones casi perfectas, como se presentan entre las variables FGM y FGA, FG3M y FG3A, y FTM y FTA, lo cual tiene sentido ya que los pares de variables mencionadas deberían estar relacionadas entre sí, ya que a nivel general una variable es el número de intentos totales de tiros, mientras que la otra es cuántos de esos tiros lograron ser encestados.</p>
<p>Por otro lado, se observa una baja correlación lineal entre la variable AGE y el resto de las variables, incluida la variable respuesta PTS. Además, en los gráficos de dispersión no se evidencia ningún tipo de correlación entre estas variables, ya que los datos se encuentran muy dispersos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> players <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">last_col</span>())</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data =</span> x1) <span class="co"># Matriz diseño, con intercepto</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> players<span class="sc">$</span>PTS <span class="co"># Variable respuesta</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="algoritmo-de-fisher-scoring" class="level3">
<h3 class="anchored" data-anchor-id="algoritmo-de-fisher-scoring">Algoritmo de Fisher-Scoring</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creación de la función</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>fisher_scoring_poisson <span class="ot">&lt;-</span> <span class="cf">function</span>(y, X, beta_init, <span class="at">tol =</span> <span class="fl">1e-7</span>, <span class="at">max_iter =</span> <span class="dv">100</span>){</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Nombramos un objeto donde se guardará el beta inicial (beta_init)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> beta_init</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iniciamos el bucle </span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>max_iter){</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># creamos un objeto "eta" que será la parte sistemática del modelo</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    eta <span class="ot">&lt;-</span> X <span class="sc">%*%</span> beta</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># creamos un objeto "mu" donde se guarda el despeje de la media de "eta"</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># creamos la matriz diagonal "W"</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">as.vector</span>(mu))</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># creamos el objeto z (variable de trabajo y^~)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> eta <span class="sc">+</span> (y <span class="sc">-</span> mu) <span class="sc">/</span> mu</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># obtenemos el nuevo beta</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    beta_new <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> W <span class="sc">%*%</span> X) <span class="sc">%*%</span> (<span class="fu">t</span>(X) <span class="sc">%*%</span> W <span class="sc">%*%</span> z)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># guardamos la matriz de varianzas y covarianzas de los betas</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    cov_beta <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> W <span class="sc">%*%</span> X)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(beta_new <span class="sc">-</span> beta)) <span class="sc">&lt;</span> tol) {</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"El algoritmo convergió en la iteración "</span>, iter)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      mu_hat <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">exp</span>(X <span class="sc">%*%</span> beta_new))</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># residual crudo</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      residual <span class="ot">&lt;-</span> y <span class="sc">-</span> mu_hat</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># residual de pearson</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      residual_pearson <span class="ot">&lt;-</span> (y <span class="sc">-</span> mu_hat) <span class="sc">/</span> <span class="fu">sqrt</span>(mu_hat)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>      <span class="co">#Residual Anscombe</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>      residual_anscombe <span class="ot">&lt;-</span> (<span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">*</span> (y<span class="sc">^</span>(<span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>) <span class="sc">-</span> mu_hat<span class="sc">^</span>(<span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>)) <span class="sc">/</span> (mu_hat<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Residual de devianza</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>      residual_deviance <span class="ot">&lt;-</span> <span class="fu">sign</span>(y <span class="sc">-</span> mu_hat) <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> (y <span class="sc">*</span> <span class="fu">log</span>(<span class="fu">ifelse</span>(y <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, y <span class="sc">/</span> mu_hat)) <span class="sc">-</span> (y <span class="sc">-</span> mu_hat)))</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>( <span class="at">beta =</span> <span class="fu">as.vector</span>(beta_new), <span class="at">predichos =</span> mu_hat, <span class="at">covarianza =</span> cov_beta, <span class="at">residual =</span> residual,</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">residual_pearson =</span> residual_pearson,</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">residual_anscombe =</span> residual_anscombe,</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>                   <span class="at">residual_deviance =</span> residual_deviance))</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    beta <span class="ot">&lt;-</span> beta_new</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"El algoritmo no convergió"</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutamos la función</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>beta_inicial <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">log</span>(<span class="fu">mean</span>(y)), <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(X)<span class="sc">-</span><span class="dv">1</span>)) <span class="co"># beta inicial</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>regresion_poisson <span class="ot">&lt;-</span> <span class="fu">fisher_scoring_poisson</span>(<span class="at">y =</span> y, <span class="at">X =</span> X, <span class="at">beta_init =</span> beta_inicial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>El algoritmo convergió en la iteración 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimación de los parámetros del modelo</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(regresion_poisson<span class="sc">$</span>beta) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"AGE"</span>, <span class="st">"MIN"</span>, <span class="st">"GP"</span>, <span class="st">"FGM"</span>, <span class="st">"FGA"</span>, <span class="st">"FG3M"</span>, <span class="st">"FG3A"</span>, <span class="st">"FTM"</span>, <span class="st">"FTA"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>regresion_poisson<span class="sc">$</span>beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Intercept           AGE           MIN            GP           FGM 
 4.1116424116  0.0076175147  0.0000747274  0.0181945865  0.0019076539 
          FGA          FG3M          FG3A           FTM           FTA 
 0.0002784068  0.0036404818 -0.0011454886  0.0001737093  0.0002852445 </code></pre>
</div>
</div>
<p>Estimación de los parámetros usando la función <code>glm</code> del paquete <code>stats</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>modelo_poisson_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> X <span class="sc">-</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(modelo_poisson_glm<span class="sc">$</span>coefficients) <span class="ot">&lt;-</span> <span class="fu">names</span>(regresion_poisson<span class="sc">$</span>beta)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>modelo_poisson_glm<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Intercept           AGE           MIN            GP           FGM 
 4.1116424116  0.0076175147  0.0000747274  0.0181945865  0.0019076539 
          FGA          FG3M          FG3A           FTM           FTA 
 0.0002784068  0.0036404818 -0.0011454886  0.0001737093  0.0002852445 </code></pre>
</div>
</div>
<p>En la siguiente tabla se puede ver la comparación con ambos métodos:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 42%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: center;">fisher_scoring_poisson</th>
<th style="text-align: center;">glm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_0} = 4.111\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_0} = 4.112\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">AGE</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_1} = 0.007617\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_1} = 0.007618\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">MIN</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_2} = 0.00007472\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_2} = 0.00007473\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">GP</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_3} = 0.01819\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_3} = 0.01819\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">FGM</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_4} = 0.001907\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_4} = 0.001908\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">FGA</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_5} = 0.0002784\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_5} = 0.0002784\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">FG3M</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_6} = 0.003640\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_6} = 0.003640\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">FG3A</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_7} = -0.001145\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_7} = -0.001145\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">FTM</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_8} = 0.0001737\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_8} = 0.0001737\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">FTA</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_9} = 0.0002852\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_9} = 0.0002852\)</span></td>
</tr>
</tbody>
</table>
<p>Los resultados parecen ser exactamente los mismos</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(regresion_poisson<span class="sc">$</span>beta, modelo_poisson_glm<span class="sc">$</span>coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>La matriz de covarianza estimada obtenida mediante el algoritmo de Fisher-Scoring coincide con la obtenida a través de la función <code>glm</code>, salvo por algunas diferencias numéricas muy pequeñas</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(regresion_poisson<span class="sc">$</span>covarianza, <span class="fu">vcov</span>(modelo_poisson_glm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Attributes: &lt; Component \"dimnames\": Component 1: 1 string mismatch &gt;"
[2] "Attributes: &lt; Component \"dimnames\": Component 2: 1 string mismatch &gt;"
[3] "Mean relative difference: 1.183917e-07"                                </code></pre>
</div>
</div>
<p>Las desviaciones estándar estimadas con ambos métodos son las siguientes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">diag</span>(regresion_poisson<span class="sc">$</span>covarianza))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)          AGE          MIN           GP          FGM          FGA 
1.573243e-02 4.749512e-04 8.853810e-06 2.315808e-04 7.836140e-05 4.481510e-05 
        FG3M         FG3A          FTM          FTA 
2.317290e-04 1.008010e-04 9.716799e-05 8.408862e-05 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(modelo_poisson_glm)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Intercept          AGE          MIN           GP          FGM          FGA 
1.573243e-02 4.749512e-04 8.853809e-06 2.315807e-04 7.836140e-05 4.481510e-05 
        FG3M         FG3A          FTM          FTA 
2.317290e-04 1.008010e-04 9.716799e-05 8.408862e-05 </code></pre>
</div>
</div>
<p>Son exactamente las mismas.</p>
<p>A continuación, se muestran gráficamente los cuatro tipos de residuales calculados: <em>residuales crudos</em>, <em>residuales de pearson</em>, <em>residuales de Anscombe</em> y <em>residuales de devianza</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_residuals <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">predichos =</span> regresion_poisson<span class="sc">$</span>predichos,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> regresion_poisson<span class="sc">$</span>residual,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_pearson =</span> regresion_poisson<span class="sc">$</span>residual_pearson,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_anscombe =</span> regresion_poisson<span class="sc">$</span>residual_anscombe,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_deviance =</span> regresion_poisson<span class="sc">$</span>residual_deviance</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráfico de los tres tipos de residuales</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual)) <span class="sc">+</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual Crudo'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual Crudo'</span>) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_pearson)) <span class="sc">+</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Pearson'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Pearson'</span>) <span class="sc">+</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_anscombe)) <span class="sc">+</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'green'</span>) <span class="sc">+</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Anscombe'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Anscombe'</span>) <span class="sc">+</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_deviance)) <span class="sc">+</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'orange'</span>) <span class="sc">+</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Devianza'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Devianza'</span>) <span class="sc">+</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>p1; p2; p3; p4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid"></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-14-3.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-14-4.png" class="img-fluid"></p>
</div>
</div>
</div>
</section>
</section>
<section id="regresión-binomial" class="level2">
<h2 class="anchored" data-anchor-id="regresión-binomial">Regresión Binomial</h2>
<ul>
<li><p>Sean <span class="math inline">\(Y_1, Y_2, \cdots, Y_n\)</span> variables aleatorias independientes con distribución <em>Binomial</em>, tales que</p>
<p><span class="math display">\[Y_i \sim Binomial(n_i, p_i) \quad i=1,2,\cdots,n.\]</span> donde <span class="math inline">\(n_i\)</span> es el número de ensayos (conocido) para la observación <span class="math inline">\(i\)</span>, y <span class="math inline">\(p_i\)</span> es la probabilidad de éxito. La variable <span class="math inline">\(Y_i\)</span> representa el número de éxitos en los <span class="math inline">\(n_i\)</span> ensayos.</p></li>
<li><p>La media de <span class="math inline">\(Y_i\)</span> es <span class="math inline">\(\mu_i = E[Y_i] = n_i p_i\)</span>.</p></li>
<li><p>La función de enlace canónica (y más común) para la probabilidad <span class="math inline">\(p_i\)</span> es la <strong>logit</strong>:</p>
<p><span class="math display">\[\eta_i = logit(p_i) = \ln\left(\frac{p_i}{1-p_i}\right)\]</span> donde <span class="math inline">\(\eta_i\)</span> es el predictor lineal: <span class="math display">\[\eta_i = \beta_0 + \beta_1X_{i1} + \beta_2X_{i2} + \cdots + \beta_pX_{ip} = x_i^T \beta\]</span></p></li>
<li><p>La relación inversa, que expresa la probabilidad <span class="math inline">\(p_i\)</span> en función del predictor lineal, es la <strong>función logística</strong>: <span class="math display">\[p_i = \frac{e^{\eta_i}}{1+e^{\eta_i}}\]</span> Y por lo tanto, la media <span class="math inline">\(\mu_i\)</span> se relaciona con <span class="math inline">\(\eta_i\)</span> a través de: <span class="math display">\[\mu_i = n_i p_i = n_i \frac{e^{\eta_i}}{1+e^{\eta_i}}\]</span></p></li>
<li><p>La función de log-verosimilitud (ignorando términos constantes como <span class="math inline">\(\ln\binom{n_i}{y_i}\)</span>) es: <span class="math display">\[
\begin{align*}
\mathcal{l}(\beta) &amp;= \sum_{i=1}^n \left[y_i\ln(p_i) + (n_i - y_i)\ln(1-p_i)\right]\\
&amp;= \sum_{i=1}^n \left[y_i \eta_i - n_i \ln(1+e^{\eta_i})\right] \\
&amp;= \sum_{i=1}^n \left[y_i (x_i^T \beta) - n_i \ln(1+\exp(x_i^T \beta))\right]
\end{align*}
\]</span></p></li>
<li><p>La <strong>función score</strong> (vector de primeras derivadas) se puede derivar y resulta ser: <span class="math display">\[\frac{\partial \mathcal{l}(\beta)}{\partial \beta} = \sum_{i=1}^n (y_i - n_i p_i)x_i = \sum_{i=1}^n (y_i - \mu_i)x_i = X^t(y - \mu)\]</span></p></li>
<li><p>La <strong>Matriz de Información de Fisher</strong> es <span class="math inline">\(I(\beta) = X^tWX\)</span>, donde <span class="math inline">\(W\)</span> es una matriz diagonal. Para calcular los elementos <span class="math inline">\(w_{ii}\)</span> de <span class="math inline">\(W\)</span>, necesitamos la varianza <span class="math inline">\(Var(Y_i)\)</span> y la derivada <span class="math inline">\(d\mu_i / d\eta_i\)</span>: <span class="math display">\[Var(Y_i) = n_i p_i (1-p_i)\]</span> <span class="math display">\[\frac{\partial \mu_i}{\partial \eta_i} = \frac{\partial (n_i p_i)}{\partial \eta_i} = n_i \frac{\partial p_i}{\partial \eta_i} = n_i \frac{e^{\eta_i}}{(1+e^{\eta_i})^2} = n_i p_i (1-p_i)\]</span> Entonces, los pesos son: <span class="math display">\[w_{ii} = \frac{\left(\frac{\partial \mu_i}{\partial \eta_i}\right)^2}{Var(y_i)} = \frac{(n_i p_i (1-p_i))^2}{n_i p_i (1-p_i)} = n_i p_i (1-p_i)\]</span></p></li>
<li><p>Nuestro <span class="math inline">\(\widetilde{y}\)</span> para el algoritmo Fisher Scoring es: <span class="math display">\[\widetilde{y} = \eta_i + (y_i - \mu_i)\frac{\partial \eta_i}{\partial \mu_i}\]</span> Dado que <span class="math inline">\(\frac{\partial \eta_i}{\partial \mu_i} = \left(\frac{\partial \mu_i}{\partial \eta_i}\right)^{-1} = \frac{1}{n_i p_i (1-p_i)}\)</span>, tenemos: <span class="math display">\[\widetilde{y} = \eta_i + \frac{y_i - \mu_i}{n_i p_i (1-p_i)}\]</span></p></li>
<li><p>El <strong>Algoritmo de Fisher-Scoring</strong> para la regresión binomial (logit) es:</p>
<ol type="1">
<li>Iniciar con un valor <span class="math inline">\(\beta^{(0)}\)</span>.</li>
<li>Obtener <span class="math inline">\(\beta^{(k+1)}\)</span> a partir de <span class="math inline">\(\beta^{(k)}\)</span> usando:
<ol type="a">
<li>Calcular <span class="math inline">\(\eta^{(k)} = X \beta^{(k)}\)</span>.</li>
<li>Calcular <span class="math inline">\(p^{(k)}_i = 1 / (1 + \exp(-\eta^{(k)}_i))\)</span>.</li>
<li>Calcular <span class="math inline">\(\mu^{(k)}_i = n_i p^{(k)}_i\)</span>.</li>
<li>Calcular pesos <span class="math inline">\(w^{(k)}_{ii} = n_i p^{(k)}_i (1-p^{(k)}_i)\)</span>. Formar <span class="math inline">\(W^{(k)}\)</span>.</li>
<li>Calcular <span class="math inline">\(\widetilde{y}^{(k)}_i = \eta^{(k)}_i + (y_i - \mu^{(k)}_i) / w^{(k)}_{ii}\)</span>. Formar <span class="math inline">\(\widetilde{y}^{(k)}\)</span>.</li>
<li>Actualizar <span class="math inline">\(\beta^{(k+1)} = \left(X^tW^{(k)}X\right)^{-1}X^tW^{(k)}\widetilde{y}^{(k)}\)</span>.</li>
</ol></li>
<li>Repetir el paso (2) hasta la convergencia.</li>
</ol></li>
</ul>
<section id="datos-simulados" class="level3">
<h3 class="anchored" data-anchor-id="datos-simulados">Datos simulados</h3>
<p>A continuación, adaptaremos el algoritmo para un caso binomial usando datos generados por simulación.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Población binomial</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1040</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulación de datos</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>xbin <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">10</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>X2 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> xbin)  <span class="co"># Incluye intercepto automáticamente</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>eta <span class="ot">&lt;-</span> X2 <span class="sc">%*%</span> beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset simulado</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>pi <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(eta))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>yb <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  yb[i] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>,<span class="at">size =</span> <span class="dv">1</span>,<span class="at">prob =</span> pi[i])</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>data_bin <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">y =</span> yb, <span class="at">x =</span> xbin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A continuación se presentan los datos simulados</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data_bin, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.02</span>, <span class="at">width =</span> <span class="dv">0</span>, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"#1f77b4"</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Distribución binomial - Datos simulados"</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Modelos_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="algoritmo-de-fisher-scoring-1" class="level3">
<h3 class="anchored" data-anchor-id="algoritmo-de-fisher-scoring-1">Algoritmo de Fisher-Scoring</h3>
<p>El algoritmo de Fisher-Scoring para la regresión logística se presenta a continuación</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creación de la función</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>fisher_scoring_binomial <span class="ot">&lt;-</span> <span class="cf">function</span>(y, X, beta_init, <span class="at">tol =</span> <span class="fl">1e-5</span>, <span class="at">max_iter =</span> <span class="dv">100</span>) {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> beta_init</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>max_iter) {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    eta <span class="ot">&lt;-</span> X <span class="sc">%*%</span> beta</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    pi <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(eta))</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    pi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(pi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">as.vector</span>(pi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> pi)))</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> eta <span class="sc">+</span> (y <span class="sc">-</span> pi) <span class="sc">/</span> (pi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> pi))</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    beta_new <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> W <span class="sc">%*%</span> X) <span class="sc">%*%</span> (<span class="fu">t</span>(X) <span class="sc">%*%</span> W <span class="sc">%*%</span> z)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Fallo al invertir la matriz. ¿X tiene multicolinealidad?"</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># guardamos la matriz de varianzas y covarianzas de los betas</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    cov_beta <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> W <span class="sc">%*%</span> X)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(beta_new <span class="sc">-</span> beta), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&lt;</span> tol) {</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Convergió en iteración "</span>, iter)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>      pi_hat <span class="ot">&lt;-</span> <span class="fu">exp</span>(X <span class="sc">%*%</span> beta_new) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(X <span class="sc">%*%</span> beta_new))</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>      pi_hat <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(pi_hat, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>) </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Resdiaul crudo</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>      residual <span class="ot">&lt;-</span> y<span class="sc">-</span>pi_hat</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Residual de pearson</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>      residual_pearson <span class="ot">&lt;-</span> (y <span class="sc">-</span> pi_hat) <span class="sc">/</span> <span class="fu">sqrt</span>(pi_hat)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Residual de Anscombe</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>      residual_anscombe <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">*</span>(y<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)<span class="sc">-</span>pi_hat<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>))<span class="sc">/</span>(pi_hat<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Residual de devianza</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle y=0 and y=1 cases for deviance</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>      dev <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(y <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> pi_hat, <span class="fu">ifelse</span>(y <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> pi_hat),</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> (y <span class="sc">*</span> <span class="fu">log</span>(y <span class="sc">/</span> pi_hat) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> y) <span class="sc">*</span> <span class="fu">log</span>((<span class="dv">1</span> <span class="sc">-</span> y) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pi_hat))))))</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>      residual_deviance <span class="ot">&lt;-</span> <span class="fu">sign</span>(y <span class="sc">-</span> pi_hat) <span class="sc">*</span> <span class="fu">sqrt</span>(dev)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">beta =</span> <span class="fu">as.vector</span>(beta_new), <span class="at">predichos =</span> pi_hat,</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>                  <span class="at">covarianza =</span> cov_beta,</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>                  <span class="at">residual =</span> residual,</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>                  <span class="at">residual_pearson =</span> residual_pearson,</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>                  <span class="at">residual_anscombe =</span> residual_anscombe,</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>                  <span class="at">residual_deviance =</span> residual_deviance))</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    beta <span class="ot">&lt;-</span> beta_new</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"No convergió"</span>)</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.vector</span>(beta))</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ejecutamos la función</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>beta_binomial <span class="ot">&lt;-</span> <span class="fu">fisher_scoring_binomial</span>(<span class="at">y =</span> yb, <span class="at">X =</span> X2, </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">beta_init =</span> <span class="fu">rep</span>(<span class="fl">0.01</span>, <span class="fu">ncol</span>(X2)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Convergió en iteración 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimación de los parámetros del modelo</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(beta_binomial<span class="sc">$</span>beta) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X2)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>beta_binomial<span class="sc">$</span>beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)        xbin 
-0.05789329  0.26830824 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>modelo_logistico <span class="ot">&lt;-</span> <span class="fu">glm</span>(yb <span class="sc">~</span> X2 <span class="sc">-</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>modelo_logistico<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X2(Intercept)        X2xbin 
  -0.05789329    0.26830824 </code></pre>
</div>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 42%">
<col style="width: 32%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: center;">fisher_scoring_binomial</th>
<th style="text-align: center;">glm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_0} = -0.05789329\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_0} = -0.05789329\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">xbin</td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_1} = 0.26830824\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\hat{\beta_1} = 0.26830824\)</span></td>
</tr>
</tbody>
</table>
<p>La matriz de covarianza estimada obtenida mediante el algoritmo de Fisher-Scoring coincide con la obtenida a través de la función <code>glm</code>, salvo por algunas diferencias numéricas muy pequeñas</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>beta_binomial<span class="sc">$</span>covarianza; <span class="fu">vcov</span>(modelo_logistico)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            (Intercept)         xbin
(Intercept)  0.19628250 -0.033856568
xbin        -0.03385657  0.008452617</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>              X2(Intercept)      X2xbin
X2(Intercept)    0.19628179 -0.03385631
X2xbin          -0.03385631  0.00845250</code></pre>
</div>
</div>
<p>La matriz de covarianza es prácticamente la misma con ambos métodos.</p>
</section>
<section id="residuales-1" class="level3">
<h3 class="anchored" data-anchor-id="residuales-1">Residuales</h3>
<p>A continuación, se muestran gráficamente los cuatro tipos de residuales calculados: <em>residuales crudos</em>, <em>residuales de pearson</em>, <em>residuales de Anscombe</em> y <em>residuales de devianza</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_residuals <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">predichos =</span> beta_binomial<span class="sc">$</span>predichos,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> beta_binomial<span class="sc">$</span>residual,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_pearson =</span> beta_binomial<span class="sc">$</span>residual_pearson,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_anscombe =</span> beta_binomial<span class="sc">$</span>residual_anscombe,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_deviance =</span> beta_binomial<span class="sc">$</span>residual_deviance</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráfico de los tres tipos de residuales</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual)) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual Crudo'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual Crudo'</span>) <span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_pearson)) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Pearson'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Pearson'</span>) <span class="sc">+</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_anscombe)) <span class="sc">+</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'green'</span>) <span class="sc">+</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Anscombe'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Anscombe'</span>) <span class="sc">+</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_deviance)) <span class="sc">+</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'orange'</span>) <span class="sc">+</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Devianza'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Devianza'</span>) <span class="sc">+</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>p1; p2; p3; p4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-25-2.png" class="img-fluid"></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-25-3.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-25-4.png" class="img-fluid"></p>
</div>
</div>
</div>
</section>
<section id="regresión-logística-con-los-datos-del-agua" class="level3">
<h3 class="anchored" data-anchor-id="regresión-logística-con-los-datos-del-agua">Regresión logística con los datos del agua</h3>
<p>A continuación, se utilizarán datos relacionados con tratamientos aplicados al agua. La variable de respuesta indica si se utilizó o no un polímero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>TURB<span class="ot">=</span><span class="fu">c</span>(<span class="dv">300</span>,<span class="dv">250</span>,<span class="dv">190</span>,<span class="dv">160</span>,<span class="dv">560</span>,<span class="dv">150</span>,<span class="dv">160</span>,<span class="dv">270</span>,<span class="dv">450</span>,<span class="dv">210</span>,<span class="dv">420</span>,<span class="dv">550</span>,<span class="dv">1200</span>,<span class="dv">420</span>,<span class="dv">500</span>,<span class="dv">150</span>,<span class="dv">200</span>,<span class="dv">390</span>,<span class="dv">380</span>,<span class="dv">140</span>,<span class="dv">170</span>,<span class="dv">1110</span>,<span class="dv">140</span>,<span class="dv">150</span>,<span class="dv">870</span>,<span class="dv">720</span>,<span class="dv">430</span>,<span class="dv">550</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>COL<span class="ot">=</span><span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">100</span>,<span class="dv">50</span>,<span class="dv">70</span>,<span class="dv">200</span>,<span class="dv">100</span>,<span class="dv">100</span>,<span class="dv">70</span>,<span class="dv">130</span>,<span class="dv">100</span>,<span class="dv">100</span>,<span class="dv">250</span>,<span class="dv">250</span>,<span class="dv">100</span>,<span class="dv">120</span>,<span class="dv">75</span>,<span class="dv">50</span>,<span class="dv">140</span>,<span class="dv">120</span>,<span class="dv">50</span>,<span class="dv">110</span>,<span class="dv">100</span>,<span class="dv">80</span>,<span class="dv">90</span>,<span class="dv">150</span>,<span class="dv">200</span>,<span class="dv">100</span>,<span class="dv">200</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>ALCA<span class="ot">=</span><span class="fu">c</span>(<span class="dv">49</span>,<span class="dv">43</span>,<span class="dv">51</span>,<span class="dv">52</span>,<span class="dv">44</span>,<span class="dv">48</span>,<span class="dv">55</span>,<span class="dv">43</span>,<span class="dv">56</span>,<span class="dv">51</span>,<span class="dv">46</span>,<span class="dv">65</span>,<span class="dv">43</span>,<span class="dv">53</span>,<span class="dv">48</span>,<span class="dv">45</span>,<span class="dv">52</span>,<span class="dv">52</span>,<span class="dv">39</span>,<span class="dv">54</span>,<span class="dv">52</span>,<span class="dv">51</span>,<span class="dv">55</span>,<span class="dv">50</span>,<span class="dv">49</span>,<span class="dv">44</span>,<span class="dv">48</span>,<span class="dv">40</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>PH<span class="ot">=</span><span class="fu">c</span>(<span class="fl">8.33</span>,<span class="fl">7.64</span>,<span class="fl">7.62</span>,<span class="fl">7.62</span>,<span class="fl">8.19</span>,<span class="fl">7.90</span>,<span class="fl">7.60</span>,<span class="fl">8.07</span>,<span class="fl">7.53</span>,<span class="fl">7.72</span>,<span class="fl">7.90</span>,<span class="fl">7.68</span>,<span class="fl">7.93</span>,<span class="fl">7.90</span>,<span class="fl">8.01</span>,<span class="fl">7.71</span>,<span class="fl">7.66</span>,<span class="fl">8.09</span>,<span class="fl">8.17</span>,<span class="fl">8.16</span>,<span class="fl">7.58</span>,<span class="fl">8.06</span>,<span class="fl">7.51</span>,<span class="fl">7.56</span>,<span class="fl">7.60</span>,<span class="fl">8.18</span>,<span class="fl">7.20</span>,<span class="fl">7.55</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>TEM<span class="ot">=</span><span class="fu">c</span>(<span class="dv">25</span>,<span class="dv">27</span>,<span class="dv">28</span>,<span class="dv">26</span>,<span class="dv">25</span>,<span class="dv">26</span>,<span class="dv">26</span>,<span class="dv">24</span>,<span class="dv">27</span>,<span class="dv">27</span>,<span class="dv">26</span>,<span class="dv">27</span>,<span class="dv">26</span>,<span class="dv">26</span>,<span class="dv">27</span>,<span class="dv">27</span>,<span class="dv">26</span>,<span class="dv">27</span>,<span class="dv">26</span>,<span class="dv">25</span>,<span class="dv">27</span>,<span class="dv">23</span>,<span class="dv">27</span>,<span class="dv">27</span>,<span class="dv">27</span>,<span class="dv">23</span>,<span class="dv">26</span>,<span class="dv">27</span>)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>POL<span class="ot">=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>Xbin2 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> TURB<span class="sc">+</span>COL<span class="sc">+</span>ALCA<span class="sc">+</span>PH<span class="sc">+</span>TEM)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>regresión_logistica_agua <span class="ot">&lt;-</span> <span class="fu">fisher_scoring_binomial</span>(<span class="at">y =</span> POL,<span class="at">X =</span> Xbin2, <span class="at">beta_init =</span> <span class="fu">c</span>(<span class="fu">log</span>(<span class="fu">mean</span>(POL)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">mean</span>(POL))), <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(Xbin2)<span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">max_iter =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Convergió en iteración 9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(regresión_logistica_agua<span class="sc">$</span>beta) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(Xbin2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Estimación de los parámetros con el algoritmo manual y la función <code>glm</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>regresión_logistica_agua<span class="sc">$</span>beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)        TURB         COL        ALCA          PH         TEM 
79.20147632  0.02551354 -0.02288018  0.06790235 -7.21260865 -1.32268428 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>modelo<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">formula =</span> POL <span class="sc">~</span> TURB<span class="sc">+</span>COL<span class="sc">+</span>ALCA<span class="sc">+</span>PH<span class="sc">+</span>TEM, <span class="at">family =</span> <span class="st">'binomial'</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>modelo<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)        TURB         COL        ALCA          PH         TEM 
79.20147609  0.02551354 -0.02288018  0.06790235 -7.21260863 -1.32268427 </code></pre>
</div>
</div>
<p>Vemos que los coeficientes estimados son prácticamente los mismos.</p>
<p>La interpretación de los coeficientes estimados del modelo es la siguiente:</p>
<ul>
<li><strong>(Intercepto)</strong> = +79.20: Es el log-odds de usar el polímero cuando todas las otras variables valen cero.</li>
<li><strong>TURB (Turbiedad)</strong> = +0.0255: A mayor turbiedad del agua, aumenta ligeramente la probabilidad de usar el polímero.</li>
<li><strong>COL (Color del agua)</strong> = -0.0229: A mayor color en el agua, disminuye ligeramente la probabilidad de usar el polímero.</li>
<li><strong>ALCA (Alcalinidad)</strong> = +0.0679: A mayor alcalinidad, aumenta la probabilidad de usar el polímero.</li>
<li><strong>PH (pH del agua)</strong> = -7.21: A mayor pH, la probabilidad de usar el polímero disminuye fuertemente.</li>
<li><strong>TEM (Temperatura)</strong> = -1.32: A mayor temperatura, disminuye la probabilidad de usar el polímero.</li>
</ul>
<p>Ahora, la matriz de covarianza de los coeficientes del modelo, se presentan a continuación</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">as.data.frame</span>(regresión_logistica_agua<span class="sc">$</span>covarianza))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 15%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 15%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">TURB</th>
<th style="text-align: right;">COL</th>
<th style="text-align: right;">ALCA</th>
<th style="text-align: right;">PH</th>
<th style="text-align: right;">TEM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">5701.5958925</td>
<td style="text-align: right;">0.6338423</td>
<td style="text-align: right;">-0.8040621</td>
<td style="text-align: right;">1.5213639</td>
<td style="text-align: right;">-403.6113478</td>
<td style="text-align: right;">-106.1212916</td>
</tr>
<tr class="even">
<td style="text-align: left;">TURB</td>
<td style="text-align: right;">0.6338423</td>
<td style="text-align: right;">0.0002784</td>
<td style="text-align: right;">-0.0003960</td>
<td style="text-align: right;">0.0008491</td>
<td style="text-align: right;">-0.0497886</td>
<td style="text-align: right;">-0.0135670</td>
</tr>
<tr class="odd">
<td style="text-align: left;">COL</td>
<td style="text-align: right;">-0.8040621</td>
<td style="text-align: right;">-0.0003960</td>
<td style="text-align: right;">0.0007516</td>
<td style="text-align: right;">-0.0015103</td>
<td style="text-align: right;">0.0658858</td>
<td style="text-align: right;">0.0165754</td>
</tr>
<tr class="even">
<td style="text-align: left;">ALCA</td>
<td style="text-align: right;">1.5213639</td>
<td style="text-align: right;">0.0008491</td>
<td style="text-align: right;">-0.0015103</td>
<td style="text-align: right;">0.0163181</td>
<td style="text-align: right;">-0.0782681</td>
<td style="text-align: right;">-0.0721145</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PH</td>
<td style="text-align: right;">-403.6113478</td>
<td style="text-align: right;">-0.0497886</td>
<td style="text-align: right;">0.0658858</td>
<td style="text-align: right;">-0.0782681</td>
<td style="text-align: right;">31.8740451</td>
<td style="text-align: right;">6.5060599</td>
</tr>
<tr class="even">
<td style="text-align: left;">TEM</td>
<td style="text-align: right;">-106.1212916</td>
<td style="text-align: right;">-0.0135670</td>
<td style="text-align: right;">0.0165754</td>
<td style="text-align: right;">-0.0721145</td>
<td style="text-align: right;">6.5060599</td>
<td style="text-align: right;">2.3821475</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">as.data.frame</span>(<span class="fu">vcov</span>(modelo)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 15%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 15%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">(Intercept)</th>
<th style="text-align: right;">TURB</th>
<th style="text-align: right;">COL</th>
<th style="text-align: right;">ALCA</th>
<th style="text-align: right;">PH</th>
<th style="text-align: right;">TEM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">5701.1409892</td>
<td style="text-align: right;">0.6337396</td>
<td style="text-align: right;">-0.8039306</td>
<td style="text-align: right;">1.5210028</td>
<td style="text-align: right;">-403.5792534</td>
<td style="text-align: right;">-106.1117714</td>
</tr>
<tr class="even">
<td style="text-align: left;">TURB</td>
<td style="text-align: right;">0.6337396</td>
<td style="text-align: right;">0.0002784</td>
<td style="text-align: right;">-0.0003959</td>
<td style="text-align: right;">0.0008489</td>
<td style="text-align: right;">-0.0497812</td>
<td style="text-align: right;">-0.0135646</td>
</tr>
<tr class="odd">
<td style="text-align: left;">COL</td>
<td style="text-align: right;">-0.8039306</td>
<td style="text-align: right;">-0.0003959</td>
<td style="text-align: right;">0.0007516</td>
<td style="text-align: right;">-0.0015101</td>
<td style="text-align: right;">0.0658762</td>
<td style="text-align: right;">0.0165724</td>
</tr>
<tr class="even">
<td style="text-align: left;">ALCA</td>
<td style="text-align: right;">1.5210028</td>
<td style="text-align: right;">0.0008489</td>
<td style="text-align: right;">-0.0015101</td>
<td style="text-align: right;">0.0163177</td>
<td style="text-align: right;">-0.0782425</td>
<td style="text-align: right;">-0.0721062</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PH</td>
<td style="text-align: right;">-403.5792534</td>
<td style="text-align: right;">-0.0497812</td>
<td style="text-align: right;">0.0658762</td>
<td style="text-align: right;">-0.0782425</td>
<td style="text-align: right;">31.8717199</td>
<td style="text-align: right;">6.5054040</td>
</tr>
<tr class="even">
<td style="text-align: left;">TEM</td>
<td style="text-align: right;">-106.1117714</td>
<td style="text-align: right;">-0.0135646</td>
<td style="text-align: right;">0.0165724</td>
<td style="text-align: right;">-0.0721062</td>
<td style="text-align: right;">6.5054040</td>
<td style="text-align: right;">2.3819389</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(regresión_logistica_agua<span class="sc">$</span>covarianza, <span class="fu">vcov</span>(modelo))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Mean relative difference: 8.019092e-05"</code></pre>
</div>
</div>
<p>Es prácticamente la misma, con diferencias numéricas muy pequeñas.</p>
<p>Veamos cómo se comportan los residuales</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df_residuals <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">predichos =</span> regresión_logistica_agua<span class="sc">$</span>predichos,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> regresión_logistica_agua<span class="sc">$</span>residual,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_pearson =</span> regresión_logistica_agua<span class="sc">$</span>residual_pearson,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_anscombe =</span> regresión_logistica_agua<span class="sc">$</span>residual_anscombe,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual_deviance =</span> regresión_logistica_agua<span class="sc">$</span>residual_deviance</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráfico de los tres tipos de residuales</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual)) <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'blue'</span>) <span class="sc">+</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual Crudo'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual Crudo'</span>) <span class="sc">+</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_pearson)) <span class="sc">+</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Pearson'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Pearson'</span>) <span class="sc">+</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_anscombe)) <span class="sc">+</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'green'</span>) <span class="sc">+</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Anscombe'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Anscombe'</span>) <span class="sc">+</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">3.1</span>, <span class="fl">1.3</span>) <span class="sc">+</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_residuals, <span class="fu">aes</span>(<span class="at">x =</span> predichos, <span class="at">y =</span> residual_deviance)) <span class="sc">+</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'orange'</span>) <span class="sc">+</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Residual de Devianza'</span>, <span class="at">x =</span> <span class="st">'Valores Predichos'</span>, <span class="at">y =</span> <span class="st">'Residual de Devianza'</span>) <span class="sc">+</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">1.3</span>, <span class="fl">1.15</span>) <span class="sc">+</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>p1; p2; p3; p4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-32-2.png" class="img-fluid"></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-32-3.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="Modelos_files/figure-html/unnamed-chunk-32-4.png" class="img-fluid"></p>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>